<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="it.italiancoders.mybudget.dao.Movement">


    <resultMap id="userMap" type="it.italiancoders.mybudget.model.api.User">
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="email" column="email"/>
        <result property="firstname" column="firstname"/>
        <result property="lastname" column="lastname"/>
        <result property="alias" column="alias"/>
        <result property="socialType" column="socialType" javaType="it.italiancoders.mybudget.model.api.SocialTypeEnum" typeHandler="org.apache.ibatis.type.EnumOrdinalTypeHandler"/>
        <result property="gender" column="gender" javaType="it.italiancoders.mybudget.model.api.GenderEnum" typeHandler="org.apache.ibatis.type.EnumOrdinalTypeHandler"/>

    </resultMap>


    <select id="findUsers" resultMap="userMap">
        select USERNAME AS username,
        PASSWORD AS password,
        EMAIL AS email,
        FIRSTNAME AS firstname,
        LASTNAME AS  lastname,
        ALIAS AS alias,
        SOCIALTYPE AS socialType,
        GENDER as gender
        from PUBLIC.USERS
        <where>
            1 = 1
            <if test="username != null">
                AND LOWER (USERNAME)= LOWER(#{username})
            </if>

        </where>

        SELECT
            mov.ID as id,
            mov.TYPE as type,
            mov.AMOUNT as amount,
            mov.EXECUTEDBY as executedBy,
            mov.EXECUTEDAT as executedAt,
            mov.NOTE as note,
            mov.CATEGORYID as categoryId,
            mov.ACCOUNTID as accountId
        FROM
        (SELECT ID, TYPE, AMOUNT, EXECUTEDBY, EXECUTEDAT, NOTE, CATEGORYID, ACCOUNTID
        FROM MOVEMENTS
        <where>
            1 = 1
            <if test="accountId != null">
                AND ACCOUNTID= #{accountId}
            </if>

            <if test="day != null">
                AND exec_day= #{day}
            </if>
            <if test="month != null">
                AND exec_month= #{month}
            </if>

            <if test="year != null">
                AND exec_year= #{year}
            </if>

        </where>
        ORDER BY EXECUTEDAT DESC
        ) AS mov
        <if test="limit != null">
        limit  #{limit}
        </if>

    </select>

    <insert id="insertMovement" >
        INSERT INTO  PUBLIC.MOVEMENTS
          (ID, TYPE, AMOUNT, EXECUTEDBY, EXECUTEDAT, NOTE, CATEGORYID, ACCOUNTID)
        VALUES
          (#{id}, #{type},#{amount},#{username},#{executedAt},#{note},#{categoryId}, #{accountId})
    </insert>


</mapper>